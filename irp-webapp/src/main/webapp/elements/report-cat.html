<link rel="import" href="../deps/polymer/polymer.html">
<link rel="import" href="../deps/paper-spinner/paper-spinner.html">
<link rel="import" href="../deps/paper-button/paper-button.html">

<dom-module id="report-cat">
    <style>
    table {
        margin: 0;
        padding: 0;
        border: 1px solid #000000;
        border-spacing: 0;
        border-collapse: collapse;
        border-spacing: 0;
        margin: 0;
        padding: 0;
    }

    th {
        border-width: 0 1px 1px 0;
        border-style: solid;
        border-color: #000000;
    }
    
    td {
        vertical-align: middle;

        border-width: 0 1px 1px 0;
        border-style: solid;
        border-color: #000000;
        text-align: left;
        padding: 11px;
        font-size: 10px;
        font-weight: normal;
        color: #000000;
    }
    </style>
    <template>

        <div>
            CAT Analysis Summary for {{catResults.subject}} Grade {{catResults.grade}}
            <div id="exposure-analysis">
                <b>Exposure Rates</b>
                <p>
                	For all available items in the pool, the number of times administered divided by the number of tests simulated for students in the particular grade and subject. 
                	For example, if item #100 is used 500 times among 10,000 simulated tests, exposure rate for item #100 is 500/10,000 = 0.05.
                </p>
                <div id="unused-items">
                    <p>
                    Total items: [[catResults.itemPoolCount]]
                    </p>
                    <p>
                    Unused items: [[catResults.unusedItems]]
                    </p>
                    <p>
                    Percent unused: [[round(catResults.percentUnused, 2)]]
                    </p>
                </div>
                <div id="used-items">
                    <p>
                        Used items: [[catResults.usedItems]]
                    </p>
                    <p>
                        Percent used: [[round(catResults.percentUsed, 2)]]
                    </p>
                </div>
                <div id="exposure-bins">
                    <b>Distribution of exposure rates</b><br>
                    <p>Bin size: [[catResults.binSize]]</p> 
                    <table>
                        <tr>
                            <td>Bin</td>
                            <template is="dom-repeat" items="{{catResults.bins}}" as="bin" index-as="index">
                                <td>[[lowerBound(catResults.binSize, index, 2)]] to [[upperBound(catResults.binSize, index, 2)]]</td>
                            </template>
                        </tr>

                        <tr>
                            <td>Count</td>
                            <template is="dom-repeat" items="{{catResults.bins}}" as="bin" index-as="index">
                                <td>[[bin]]</td>
                            </template>
                        </tr>
                    </table>
                </div>
            </div>
            <div id="score-summary">
                <b>Score Summary</b>
                <p>
                	Score estimates are compared against the true/generating scores. Summaries are available as Average Bias and Root Mean Squared Error (RMSE)
                	These summaries are also computed against the scores partitioned into deciles.
                </p>
                <table>
                    <tr>
                        <td>Average Bias</td>
                        <td>[[round(catResults.averageBias,3)]]</td>
                    </tr>
                    <tr>
                        <td>Root Mean Squared Error (RMSE)</td>
                        <td>[[round(catResults.rmse,3)]]</td>
                    </tr>
                </table>
                <div id="score-summary-deciles">
                    <b>Average Bias by Decile</b>
                    <table>
						<tr>				
							<td><b>Decile</b></td>			
                   			<template is="dom-repeat" items="{{catResults.decileAverageBias}}" as="avgBias" index-as="index">
                   				<td>[[addOne(index)]]</td>
                   			</template>                   				
                   		</tr>
						<tr>				
							<td><b>Mean Bias</b></td>			
                   			<template is="dom-repeat" items="{{catResults.decileAverageBias}}" as="avgBias" index-as="index">
                   				<td>[[round(avgBias, 3)]]</td>
                   			</template>                   				
                   		</tr>
                    </table>
                    <b>RMSE by Decile</b>
                    <table>
                   		<tr>
                   			<td><b>Decile</b></td>
                    		<template is="dom-repeat" items="{{catResults.decileRmse}}" as="rmse" index-as="index">
	                        	<td>[[addOne(index)]]</td>
                        	</template>
                       	</tr>
                       	<tr>
                       		<td><b>RMSE</b></td>
                       		<template is="dom-repeat" items="{{catResults.decileRmse}}" as="rmse" index-as="index">
	                        	<td>[[round(rmse, 3)]]</td>
                    		</template>
                   		</tr>
                    </table>
                </div>
            </div>
            <div id="precision-scores">
                <b>Precision Summary</b>
		        <p>
		        	Precision is scored by the overall mean standard error of measurement and by claim.
		        </p>
                <p>Mean Overall Standard Error of Measurement [[round(catResults.overallSEM, 3)]]</p>
                <p>Claim 1 Mean Standard Error of Measurement [[round(catResults.claim1SEM, 3)]]</p>
                <template is="dom-if" if="[[isEla(catResults.subject)]]">
                    <p>Claim 2 Mean Standard Error of Measurement [[round(catResults.claim2SEM, 3)]]</p>
                </template>
                <template is="dom-if" if="[[isMath(catResults.subject)]]">
                 <p>Combined Claim 2-4 Mean Standard Error of Measurement [[round(catResults.claim2_4SEM, 3)]]</p>
                </template>
                <p>Claim 3 Mean Standard Error of Measurement [[round(catResults.claim3SEM, 3)]]</p>
                <template is="dom-if" if="[[isEla(catResults.subject)]]">
                    <p>Claim 4 Mean Standard Error of Measurement [[round(catResults.claim4SEM, 3)]]</p>
                </template>
            </div>
            <div id="score-levels">
        	<p>
        		<ul>
        			<li>
        				For every true score and estimated scale score, there are corresponding levels. 
        				For the overall score, students are assigned to one of four possible levels. 
        			</li>
        			<li>Cut scores by grade and subject can be found here (pp. 8-9): <a href="http://www.smarterapp.org/documents/TestScoringSpecs2014-2015.pdf">http://www.smarterapp.org/documents/TestScoringSpecs2014-2015.pdf</a></li>
        		</ul>
        	</p>
                <b>Classification Levels</b>
                <table id="score-table">
                    <thead>Score Levels</thead>
                    <td></td><td colspan="4">True Level</td>
                    <tr>
                        <td>Estimated Level</td>
                        <template is="dom-repeat" items="{{catResults.classAccMatrix}}" index-as="y">
                            <td>{{addOne(y)}}</td>
                        </template>
                    </tr>
                    <template is="dom-repeat" items="{{catResults.classAccMatrix}}" as="estLevel" index-as="x">
                        <tr>
                        <td>{{addOne(x)}}</td>
                        <template is="dom-repeat" items="{{estLevel}}" as="trueLevel">
                            <td>{{trueLevel}}</td>
                        </template>
                        </tr>
                    </template>
                </table>
                <p>Classification accuracy: [[round(catResults.classAccuracy, 2)]]</p>
            </div>
            <div id="blueprint-violations">
            	<b>Blueprint Violations</b>
            	<p>
            		Blueprint violations are summarized for ELA from <a href="https://www.smarterbalanced.org/wp-content/uploads/2015/08/ELA_Blueprint.pdf">https://www.smarterbalanced.org/wp-content/uploads/2015/08/ELA_Blueprint.pdf</a> and for Math from 
            		<a href="https://www.smarterbalanced.org/wp-content/uploads/2015/08/Mathematics_Blueprint.pdf">https://www.smarterbalanced.org/wp-content/uploads/2015/08/Mathematics_Blueprint.pdf</a>
            		Summaries are given based on the number of tests that fall under, over or match the blueprint specification.
            	</p>
                <b>Violation Counts</b>
                <table>
                    <tr>
                        <td>Specification</td>
                        <td>Min</td>
                        <td>Max</td>
                        <td>Under</td>
                        <td>Match</td>
                        <td>Over</td>
                    </tr>
                    <template is="dom-repeat" items="{{catResults.blueprintStatements}}" as="blueprint">
                        <tr>
                            <td>[[blueprint.specification]]</td>
                            <td>[[blueprint.min]]</td>
                            <td>[[blueprint.maxStr]]</td>
                            <td>[[blueprint.violationCount.under]]</td>
                            <td>[[blueprint.violationCount.match]]</td>
                            <td>[[blueprint.violationCount.over]]</td>
                        </tr>
                    </template>
                </table>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'report-cat',
            properties: {
                catResults: {
                    type: Object,
                    notify: true
                }
            },
            addOne: function(val) {
                return val + 1;
            },
            ready: function () {
            },
            round: function(value, places) {
                return value.toFixed(places);
            },
            nonZero: function(val) {
                return val > 0;
            },
            lowerBound: function(binSize, index, roundDigits) {
                return this.round(binSize * index, 2);
            },
            upperBound: function(binSize, index, roundDigits) {
                return this.lowerBound(binSize, index + 1, 2);
            },
            isEla: function(subject) {
                return subject != null && subject.toLowerCase() === "ela";
            },
            isMath: function(subject) {
                return subject != null && subject.toLowerCase() === "math";
            },
            _toArray: function(obj) {
                return Object.keys(obj).map(function(key) {
                    return {
                        name: key,
                        value: obj[key]
                    };
                });
            }
        });
    </script>
</dom-module>